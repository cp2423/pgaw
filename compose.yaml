services:
  db:
    build: db
    restart: always
    # image manual says to set shared memory limit
    shm_size: 128mb
    # expose port for direct connections
    ports:
      - 5432:5432
    networks:
      - backnet
    environment:
      - POSTGRES_DB=adventureworks
      - POSTGRES_PASSWORD=/run/secrets/dbroot
      - READONLY_PWD_FILE=/run/secrets/readonly
    secrets:
      - dbroot
      - readonly
    volumes:
      - pgdata:/var/lib/postgresql/data

  backend:
    build: backend
    restart: always
    depends_on:
      - db
    networks:
      - backnet
      - frontnet
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@foo.com
      - PGADMIN_DEFAULT_PASSWORD_FILE=/run/secrets/pgadmin
    secrets:
      - pgadmin
    deploy:
      replicas: 3
      resources:
         limits:
            # appropriate for a 2GB RPi
            cpus: '0.5'
            memory: 400m

  proxy:
    build: proxy
    restart: always
    ports:
    - 80:80
    depends_on:
    - backend
    networks:
    - frontnet

networks:
  backnet:
  frontnet:

secrets:
  dbroot:
    file: ../passwords/dbroot.txt
  readonly:
    file: ../passwords/readonly.txt
  pgadmin:
    file: ../passwords/pgadmin.txt

volumes:
  pgdata:
